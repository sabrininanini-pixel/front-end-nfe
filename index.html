<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferir Nota Fiscal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        
        /* --- ESTILO BASE: SCROLL MODE (Com scroll, texto não quebra) --- */
        .mock-table {
            width: max-content !important; 
        }

        .mock-table th, .mock-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; 
            border-right: 1px solid #e5e7eb; 
            
            white-space: nowrap; /* Força o conteúdo a ficar em uma linha */
            text-overflow: clip; 
            overflow: visible; 
        }
        
        /* ---------------------------------------------------------------- */
        /* --- ESTILOS DE LARGURA FIXA PARA MODO SCROLL (Larguras Solicitadas) --- */
        /* ---------------------------------------------------------------- */

        /* 1. NOTA FISCAL (4 Colunas) */
        
        /* Coluna 1: Descrição (Maior - 250px) */
        #dynamic-table-content .mock-table th:nth-child(1),
        #dynamic-table-content .mock-table td:nth-child(1) {
            min-width: 250px; 
        }

        /* Coluna 2: Quantidade (70px) */
        #dynamic-table-content .mock-table th:nth-child(2),
        #dynamic-table-content .mock-table td:nth-child(2) {
            min-width: 70px;
            text-align: center;
        }

        /* Coluna 3: Código de Barras (140px) */
        #dynamic-table-content .mock-table th:nth-child(3),
        #dynamic-table-content .mock-table td:nth-child(3) {
            min-width: 140px;
        }

        /* Coluna 4: Item (70px) */
        #dynamic-table-content .mock-table th:nth-child(4),
        #dynamic-table-content .mock-table td:nth-child(4) {
            min-width: 70px;
            text-align: center;
        }

        /* 2. CONFERENCIA (6 Colunas) */
        
        /* Coluna 1: Código de Barras (140px) */
        #conferencia-content .mock-table th:nth-child(1),
        #conferencia-content .mock-table td:nth-child(1) {
            min-width: 140px;
        }

        /* Coluna 2: Descrição (Maior - 250px) */
        #conferencia-content .mock-table th:nth-child(2),
        #conferencia-content .mock-table td:nth-child(2) {
            min-width: 250px;
        }

        /* Coluna 3: Quantidade NF (100px) */
        #conferencia-content .mock-table th:nth-child(3),
        #conferencia-content .mock-table td:nth-child(3) {
            min-width: 100px;
            text-align: center;
        }

        /* Coluna 4: Contagem Loja (100px) */
        #conferencia-content .mock-table th:nth-child(4),
        #conferencia-content .mock-table td:nth-child(4) {
            min-width: 100px;
            text-align: center;
        }

        /* Coluna 5: Diferença (70px) */
        #conferencia-content .mock-table th:nth-child(5),
        #conferencia-content .mock-table td:nth-child(5) {
            min-width: 70px;
            text-align: center;
        }

        /* Coluna 6: Status/OBS (100px) */
        #conferencia-content .mock-table th:nth-child(6),
        #conferencia-content .mock-table td:nth-child(6) {
            min-width: 100px;
        }

        /* --- ESTILO PARA MODO EXPANDIDO (Sem scroll, texto quebra) --- */
        .mock-table.expand-mode {
            width: 100% !important; 
            table-layout: auto; 
        }
        
        .mock-table.expand-mode th, 
        .mock-table.expand-mode td {
            white-space: normal !important; 
            word-break: break-word; 
            /* REVERTE as larguras fixas quando está no modo expandido */
            min-width: auto !important; 
        }

        /* Regra para remover a linha vertical da última coluna */
        .mock-table th:last-child, .mock-table td:last-child {
            border-right: none;
        }

        .mock-table th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #4b5563; /* gray-600 */
        }
        .mock-table tr:hover {
            background-color: #f9fafb; /* gray-50 */
        }

        /* ---------------------------------------------------------------- */
        /* --- Estilos de Edição/Conferência --- */
        /* ---------------------------------------------------------------- */
        
        /* Estilos base para a coluna Diferença (E - 5ª coluna visível) */
        #conferencia-content tr td:nth-child(5) { 
            font-weight: bold;
            text-align: center;
        }


        /* --- CORES PARA O FUNDO DA CÉLULA DIFERENÇA (Ajustado com alta especificidade) --- */
        /* Vermelho (Negativo) */
        #conferencia-content tr td:nth-child(5).bg-fee2e2 { 
            background-color: #fee2e2 !important; 
        }
        #conferencia-content tr td:nth-child(5).text-b91c1c { 
            color: #b91c1c !important; 
        }
        /* Verde (Positivo) */
        #conferencia-content tr td:nth-child(5).bg-green-100 { 
            background-color: #d1fae5 !important; 
        } 
        #conferencia-content tr td:nth-child(5).text-green-700 { 
            color: #047857 !important; 
        } 
        /* --------------------------------------------------------------------------------- */


        /* Estilo para células editáveis (Contagem Loja / Status) */
        [contenteditable="true"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #c7d2fe;
        }
        
        /* ---------------------------------------------------------------- */
        /* --- PADDING RESPONSIVO (Apenas para celular < 768px) --- */
        /* ---------------------------------------------------------------- */
        @media (max-width: 767px) {
            
            /* Ajustes visuais para mobile */
            .container {
                padding: 0 !important;
                max-width: 100% !important;
            }
            
            .container .bg-white {
                border-radius: 0;
                border-left: none;
                border-right: none;
                padding: 1.5rem 0 !important; 
            }
            
            header, nav, .flex.flex-wrap, #content-stack {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            nav {
                border-bottom: 1px solid #e5e7eb; 
                margin: 0 1rem; 
            }
            
            .overflow-x-auto {
                border-radius: 0 !important;
                box-shadow: none !important;
                border: none !important;
                padding-left: 0; 
                padding-right: 0;
            }
        }
        
        /* ---------------------------------------------------------------- */
        /* --- Estilos de Impressão (A4) --- */
        /* ---------------------------------------------------------------- */
        @media print {
            body {
                margin: 0;
                padding: 0;
                width: 210mm; 
                min-height: 297mm;
            }

            /* Esconde elementos não essenciais para a impressão */
            .container, .bg-white, .shadow-lg {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: none !important;
                border: none !important;
            }
            header, nav, #paste-modal, #notifications-container, .print-hidden {
                display: none !important;
            }

            /* Garante que a tabela use 100% da largura do A4 */
            .mock-table {
                width: 100% !important;
                font-size: 10pt;
            }
            .mock-table th, .mock-table td {
                padding: 4px; 
                border-bottom: 1px solid #ccc;
                border-right: 1px solid #ccc;
                /* Permite a quebra de linha na impressão */
                white-space: normal !important; 
            }
            /* Remove min-width para que caiba no papel */
            .mock-table th, .mock-table td {
                 min-width: auto !important;
            }
            .mock-table th:last-child, .mock-table td:last-child {
                border-right: none;
            }
            
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6 print-hidden">
            <h1 class="text-3xl font-extrabold text-gray-900">
                Conferir Nota Fiscal
            </h1>
        </header>

        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">

            <nav class="flex border-b border-gray-200 print-hidden">
                <button data-tab="NOTA FISCAL" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 transition-colors duration-150">NOTA FISCAL</button>
                <button data-tab="CONTAGEM LOJA" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">CONTAGEM LOJA</button>
                <button data-tab="CONFERENCIA" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">CONFERENCIA</button>
            </nav>

            <div id="content-stack" class="pt-6">
            </div>
            
        </div>
    </div>

    <div id="paste-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 print-hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 p-6">
            <h3 class="text-lg font-bold mb-4">Colar Chave de Acesso (44 dígitos)</h3>
            <textarea id="chave-acesso-input" class="w-full h-24 p-3 border border-gray-300 rounded-lg resize-none text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="Cole a Chave de Acesso (44 dígitos) aqui..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="hidePasteModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                <button onclick="importarXMLPorChave()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">Importar XML por Chave</button>
            </div>
        </div>
    </div>

    <div id="notifications-container" class="fixed bottom-4 right-4 space-y-2 z-50 print-hidden">
    </div>

    <script>
        // --- Variáveis de Configuração ---
        const BACKEND_URL = "https://back-end-nfe.onrender.com";
        const USER_ID = "web-user-123";
        
        // --- Gerenciamento de Abas e Modo de Visualização ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentStack = document.getElementById('content-stack');
        let currentTab = 'NOTA FISCAL'; 
        
        // Estado do Modo: True = Scroll Mode (Padrão), False = Expand Mode
        let scrollModeActive = true; 
        
        // Ícones de Modo de Visualização
        const scrollModeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>`;
        const expandModeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg>`;


        tabButtons.forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });

        /**
         * Altera a aba ativa e carrega o conteúdo.
         */
        function switchTab(sheetName) {
            currentTab = sheetName; 
            
            // 1. Atualiza o estilo dos botões
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === sheetName) {
                    btn.classList.add('border-indigo-600', 'text-indigo-600');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                } else {
                    btn.classList.remove('border-indigo-600', 'text-indigo-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                }
            });

            // 2. Limpa o conteúdo e define o placeholder de carregamento
            contentStack.innerHTML = `<div class="text-center py-10 text-gray-500">Carregando dados de ${sheetName}...</div>`;
            
            // 3. Renderiza o layout específico da aba (se houver)
            if (sheetName === "NOTA FISCAL") {
                contentStack.innerHTML = renderNotaFiscalLayout();
            } else if (sheetName === "CONTAGEM LOJA") {
                contentStack.innerHTML = renderContagemLojaLayout();
            } else if (sheetName === "CONFERENCIA") {
                contentStack.innerHTML = renderConferenciaLayout();
            }
            
            // 4. Inicia a busca de dados no backend
            loadTabContent(sheetName);
        }

        const documentIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
        const printerIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m-1-5a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2zm-4 4h4v2a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2h4z" /></svg>`;


        /**
         * Retorna o HTML completo da aba NOTA FISCAL (botões + placeholder da tabela).
         */
        function renderNotaFiscalLayout() {
            const modeText = scrollModeActive ? "Modo Expandido" : "Modo Scroll";
            const modeIcon = scrollModeActive ? expandModeIcon : scrollModeIcon;
            
            return `
                <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                    <label for="xml-file-upload" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 cursor-pointer text-sm font-medium border border-gray-300">
                        <span class="text-orange-600">${documentIcon}</span>
                        <span>Importar Nota Fiscal (XML)</span>
                    </label>
                    <input type="file" id="xml-file-upload" accept=".xml" class="hidden" onchange="handleFileUploadChange(event)">
                    
                    <button id="show-paste-modal" onclick="showPasteModal()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
                        <span class="text-yellow-600">${documentIcon}</span>
                        <span>Importar por Chave de Acesso</span>
                    </button>
                    
                    <button id="toggle-scroll-btn-nf" onclick="toggleTableMode()" class="flex items-center space-x-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:bg-indigo-200 transition duration-150 text-sm font-medium border border-indigo-300">
                        <span id="nf-toggle-icon-container">
                            ${modeIcon}
                        </span>
                        <span id="nf-toggle-text-container">
                            ${modeText}
                        </span>
                    </button>
                    
                    <button onclick="confirmClearAllSheets()" class="flex items-center space-x-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg shadow-sm hover:bg-red-100 transition duration-150 text-sm font-medium border border-red-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-2 0v6a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
                        <span>Apagar Dados</span>
                    </button>
                </div>
                <div id="dynamic-table-content">
                    <p class="text-center text-gray-400 py-10">Use o botão de importação (XML) para carregar dados nesta aba.</p>
                </div>
            `;
        }

        /**
         * Retorna o HTML completo da aba CONTAGEM LOJA.
         */
        function renderContagemLojaLayout() {
            return `
                <div id="contagem-loja-content">
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4 print-hidden">
                        <p class="font-semibold text-yellow-800 text-lg">Escanear abaixo</p>
                    </div>
                    <div id="dynamic-table-content-contagem">
                        <p class="text-center text-gray-400 py-10">Carregando dados...</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Retorna o HTML completo da aba CONFERENCIA (com botão de impressão e toggle).
         */
        function renderConferenciaLayout() {
            const modeText = scrollModeActive ? "Modo Expandido" : "Modo Scroll";
            const modeIcon = scrollModeActive ? expandModeIcon : scrollModeIcon;
            
            return `
                <div id="conferencia-content">
                    <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                        
                        <button onclick="printConferencia()" class="flex items-center space-x-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg shadow-sm hover:bg-blue-200 transition duration-150 text-sm font-medium border border-blue-300">
                            <span class="text-blue-600">${printerIcon}</span>
                            <span>Imprimir Conferência</span>
                        </button>

                        <button id="toggle-scroll-btn-conf" onclick="toggleTableMode()" class="flex items-center space-x-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:bg-indigo-200 transition duration-150 text-sm font-medium border border-indigo-300">
                            <span id="conf-toggle-icon-container">
                                ${modeIcon}
                            </span>
                            <span id="conf-toggle-text-container">
                                ${modeText}
                            </span>
                        </button>

                    </div>
                    <div id="dynamic-table-content-conferencia">
                        <p class="text-center text-gray-400 py-10">Carregando dados...</p>
                    </div>
                </div>
            `;
        }

        /**
         * Abre a caixa de diálogo de impressão do navegador com estilos A4.
         */
        function printConferencia() {
            window.print();
        }

        /**
         * Renderiza os dados do Sheets em uma tabela HTML.
         */
        function renderTable(sheetName, data, headers, isEditable = false) {
            
            if (!data || data.length === 0) {
                if (sheetName === "CONTAGEM LOJA") {
                     return renderEmptyContagemTable(sheetName, headers);
                }
                return `<p class="text-center text-gray-500 py-10">Nenhum dado encontrado no Google Sheets para esta aba.</p>`;
            }

            const isStatusEditable = sheetName === "CONFERENCIA";
            
            let html = `
                <div class="rounded-lg border border-gray-200 overflow-x-auto shadow-sm">
                    <table class="mock-table text-sm" id="${isEditable ? 'contagem-table' : (isStatusEditable ? 'conferencia-table' : '')}">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>`;
            
            headers.forEach(h => {
                html += `<th class="w-auto whitespace-nowrap">${h}</th>`;
            });
            html += `</tr></thead><tbody>`;

            let dataRows = data;
            
            if (data.length > 0 && headers.length > 0 && String(data[0][0]) === headers[0]) {
                dataRows = data.slice(1);
            }

            let lastRowIndexInSheet = 0;

            dataRows.forEach((row, rowIndex) => {
                const isRowEmpty = row.length === 0 || row.every(cell => !cell || String(cell).trim() === '');
                if (isRowEmpty) return;

                const sheetRowIndex = (data[0][0] === headers[0] ? rowIndex + 2 : rowIndex + 1);
                lastRowIndexInSheet = sheetRowIndex;
                
                html += `<tr data-row-index="${sheetRowIndex}">`;
                
                for (let i = 0; i < headers.length; i++) {
                    const cellValue = row[i] !== undefined ? row[i] : '';
                    
                    const sheetCol = String.fromCharCode(65 + i);
                    const sheetRange = `${sheetCol}${sheetRowIndex}`;

                    let editAttributes = '';
                    let cellClasses = '';

                    const isCellEditable = (isEditable && i === 0) || (isStatusEditable && i === 5);

                    if (isCellEditable) {
                        editAttributes = `contenteditable="true"
                                         onblur="handleCellEdit(this, '${sheetRange}', '${sheetName}')"
                                         data-original-value="${cellValue}"
                                         data-sheet-range="${sheetRange}"`;

                        if (sheetName === "CONTAGEM LOJA") {
                            editAttributes += `onkeydown="handleContagemKeyPress(event, '${sheetRange}', '${sheetName}')"`;
                        }
                        
                        cellClasses = 'cursor-text hover:bg-indigo-50/50 focus:bg-indigo-100 border border-transparent focus:border-indigo-400 transition';
                    }

                    html += `<td ${editAttributes} class="${cellClasses}">${cellValue}</td>`;
                }
                html += `</tr>`;
            });
            
            if (isEditable && sheetName === "CONTAGEM LOJA") {
                const nextRowIndex = lastRowIndexInSheet + 1;
                
                if (lastRowIndexInSheet !== 0) {
                    html += renderEditableRow(sheetName, headers, nextRowIndex);
                } else {
                    // Se estiver vazio, renderiza a linha inicial A2
                    html += renderEditableRow(sheetName, headers, 2);
                }
            }

            html += `</tbody></table></div>`;
            return html;
        }

        /**
         * Renderiza a linha editável vazia para começar a contagem.
         */
        function renderEmptyContagemTable(sheetName, headers) {
             const startRowIndex = 2;

             const firstEditableRow = renderEditableRow(sheetName, headers, startRowIndex);
             
             return `
                 <div class="rounded-lg border border-gray-200 overflow-x-auto shadow-sm">
                    <table class="mock-table text-sm" id="contagem-table">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr><th>${headers[0]}</th></tr>
                        </thead>
                        <tbody>
                            ${firstEditableRow}
                        </tbody>
                    </table>
                </div>
             `;
        }

        /**
         * Renderiza uma linha vazia com a primeira célula editável (usada apenas pela Contagem Loja).
         */
        function renderEditableRow(sheetName, headers, sheetRowIndex) {
            let html = `<tr data-row-index="${sheetRowIndex}">`;
            
            const sheetCol = 'A';
            const sheetRange = `${sheetCol}${sheetRowIndex}`;
            
            const editAttributes = `contenteditable="true"
                                    onblur="handleCellEdit(this, '${sheetRange}', '${sheetName}')"
                                    onkeydown="handleContagemKeyPress(event, '${sheetRange}', '${sheetName}')"
                                    data-original-value=""
                                    data-sheet-range="${sheetRange}"`;
            
            const cellClasses = 'cursor-text hover:bg-indigo-50/50 focus:bg-indigo-100 border border-transparent focus:border-indigo-400 transition';

            html += `<td ${editAttributes} class="${cellClasses}"></td>`;
            
            for (let i = 1; i < headers.length; i++) {
                html += `<td></td>`;
            }
            
            html += `</tr>`;
            return html;
        }


        /**
         * Gerencia a busca de dados e a renderização do conteúdo da aba.
         */
        async function loadTabContent(sheetName) {
            const data = await fetchSheetData(sheetName);

            let targetElementId = 'dynamic-table-content';
            let headers = [];
            let isEditable = false;

            if (sheetName === "NOTA FISCAL") {
                headers = ["Descrição", "Quantidade", "Código de Barras", "Item"];
            } else if (sheetName === "CONTAGEM LOJA") {
                headers = ["Código de Barras"]; 
                targetElementId = 'dynamic-table-content-contagem';
                isEditable = true;
            } else if (sheetName === "CONFERENCIA") {
                headers = ["Código de Barras", "Descrição do Produto", "Quantidade NF", "Contagem Loja", "Diferença", "Status"];
                targetElementId = 'dynamic-table-content-conferencia';
            }

            const targetElement = document.getElementById(targetElementId);
            if (targetElement) {
                targetElement.innerHTML = renderTable(sheetName, data, headers, isEditable);
                
                // --- Aplica o modo de visualização correto após a renderização ---
                if (sheetName === "NOTA FISCAL" || sheetName === "CONFERENCIA") {
                     setTimeout(updateTableModeDisplay, 0); 
                }
                
                // --- Aplica estilos condicionais após a renderização ---
                if (sheetName === "CONFERENCIA") {
                    setTimeout(() => {
                        applyConferenciaStyles(headers.length);
                    }, 0);
                }
                
            } else if (sheetName !== "NOTA FISCAL" && sheetName !== "CONTAGEM LOJA") {
                contentStack.innerHTML = `
                    <div id="${sheetName.toLowerCase()}-content">
                        ${renderTable(sheetName, data, headers, isEditable)}
                    </div>
                `;
                if (sheetName === "CONFERENCIA") {
                     setTimeout(updateTableModeDisplay, 0); 
                    setTimeout(() => {
                        applyConferenciaStyles(headers.length);
                    }, 0);
                }
            }
        }

        /**
         * Alterna entre o modo Scroll Horizontal e o modo Expandido.
         */
        function toggleTableMode() {
            scrollModeActive = !scrollModeActive;
            updateTableModeDisplay();
        }

        /**
         * Aplica as classes CSS e atualiza o botão de acordo com o estado atual (scrollModeActive).
         */
        function updateTableModeDisplay() {
            let tableSelector = '';
            let toggleIconId = '';
            let toggleTextId = '';

            // 1. Determina os IDs corretos para a aba ativa
            if (currentTab === "NOTA FISCAL") {
                tableSelector = '#dynamic-table-content .mock-table';
                toggleIconId = 'nf-toggle-icon-container';
                toggleTextId = 'nf-toggle-text-container';
            } else if (currentTab === "CONFERENCIA") {
                tableSelector = '#dynamic-table-content-conferencia .mock-table';
                toggleIconId = 'conf-toggle-icon-container';
                toggleTextId = 'conf-toggle-text-container';
            } else {
                return; 
            }

            const table = document.querySelector(tableSelector);
            const toggleIconContainer = document.getElementById(toggleIconId);
            const toggleTextContainer = document.getElementById(toggleTextId);
            
            if (!table || !toggleIconContainer || !toggleTextContainer) {
                return;
            }
            
            const scrollContainer = table.parentElement; 
            
            if (scrollModeActive) {
                // Modo SCROLL (Pronto para rolar)
                table.classList.remove('expand-mode');
                scrollContainer.classList.remove('overflow-x-hidden'); 
                scrollContainer.classList.add('overflow-x-auto');

                // Atualiza o botão para indicar a próxima ação (Expandir)
                toggleIconContainer.innerHTML = expandModeIcon; 
                toggleTextContainer.textContent = "Modo Expandido";
                
            } else {
                // Modo EXPANDIDO (Ocupa 100%, quebra texto)
                table.classList.add('expand-mode');
                scrollContainer.classList.remove('overflow-x-auto'); 
                scrollContainer.classList.add('overflow-x-hidden'); 

                // Atualiza o botão para indicar a próxima ação (Rolar)
                toggleIconContainer.innerHTML = scrollModeIcon; 
                toggleTextContainer.textContent = "Modo Scroll";
            }
        }

        
        /**
         * Aplica formatação condicional à coluna Diferença (E) na aba CONFERENCIA.
         */
        function applyConferenciaStyles(numCols) {
            const rows = document.querySelectorAll('#conferencia-content .mock-table tbody tr');

            rows.forEach(row => {
                const diffCell = row.querySelector('td:nth-child(5)');
                if (!diffCell) return;

                let value = parseFloat(diffCell.textContent.replace(',', '.').trim());
                
                diffCell.classList.remove('bg-fee2e2', 'text-b91c1c', 'bg-green-100', 'text-green-700');

                if (isNaN(value) || value === 0) {
                    // Valor Zero ou Vazio (Neutro)
                } else if (value < 0) {
                    // Regra Vermelha (Negativo)
                    diffCell.classList.add('bg-fee2e2', 'text-b91c1c');
                } else if (value > 0) {
                    // Regra Verde (Positivo)
                    diffCell.classList.add('bg-green-100', 'text-green-700');
                }
            });
        }


        // --- Funções de API e Utilitários (Não Alteradas) ---

        function handleContagemKeyPress(event, sheetRange, sheetName) {
            if (event.keyCode === 13) {
                event.preventDefault();
                
                const element = event.target;
                handleCellEdit(element, sheetRange, sheetName);

                const currentRow = parseInt(sheetRange.slice(1));
                const nextRow = currentRow + 1;
                const nextRange = `A${nextRow}`;

                const nextCell = document.querySelector(`td[data-sheet-range="${nextRange}"]`);
                
                if (nextCell) {
                    nextCell.textContent = '';
                    nextCell.dataset.originalValue = '';
                    nextCell.focus();
                } else {
                    const tableBody = document.querySelector('#contagem-table tbody');
                    if (tableBody) {
                        const placeholderRows = tableBody.querySelectorAll('tr[data-placeholder="true"]');
                        placeholderRows.forEach(row => row.remove());
                        
                        const headers = ["Código de Barras"];
                        const newRowHtml = renderEditableRow(sheetName, headers, nextRow);
                        tableBody.insertAdjacentHTML('beforeend', newRowHtml);
                        
                        const newCell = document.querySelector(`td[data-sheet-range="${nextRange}"]`);
                        if (newCell) {
                            newCell.focus();
                        }
                    }
                }
            }
        }

        async function fetchSheetData(sheetName) {
            showNotification(`Buscando dados da aba '${sheetName}'...`, 'loading');
            
            try {
                const response = await fetch(`${BACKEND_URL}/fetch-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_name: sheetName })
                });

                const result = await response.json();
                hideNotification();

                if (!response.ok || result.error) {
                    showNotification(`Erro ao carregar '${sheetName}': ${result.error || 'Erro de servidor.'}`, 'error');
                    return [];
                }
                
                return result.data || [];

            } catch (error) {
                hideNotification();
                console.error("Erro na comunicação para buscar dados:", error);
                showNotification(`Erro de Rede/CORS ao buscar dados para ${sheetName}.`, 'error');
                return [];
            }
        }
        
        async function importXMLData(xmlContent) {
            if (!xmlContent || xmlContent.trim().length < 100) {
                showNotification("Conteúdo XML vazio ou inválido para importação.", 'warning');
                return;
            }

            showNotification("Enviando XML para o backend Go...", 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/import-xml-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ xml_content: xmlContent, user_id: USER_ID })
                });

                const result = await response.json();
                hideNotification();

                if (!response.ok || result.error) {
                    showNotification(`Falha na Importação: ${result.error || 'Erro desconhecido do servidor.'}`, 'error');
                } else {
                    showNotification(result.message, 'success');
                    switchTab("NOTA FISCAL");
                }

            } catch (error) {
                hideNotification();
                console.error("Erro de Rede:", error);
                showNotification("Erro de Rede ao tentar conectar com o servidor Go. Verifique se ele está rodando em https://back-end-nfe.onrender.com", 'error');
            }
        }

        async function importarXMLPorChave() {
            const chaveInput = document.getElementById("chave-acesso-input");
            if (!chaveInput) {
                showNotification("Campo de chave não encontrado.", "error");
                return;
            }
            const chaveAcesso = chaveInput.value.trim();

            if (!chaveAcesso || chaveAcesso.length !== 44) {
                showNotification("Chave de acesso inválida. Deve conter 44 dígitos.", "warning");
                return;
            }

            showNotification("Importando XML pela chave de acesso...", "loading");

            try {
                const response = await fetch(`${BACKEND_URL}/importar-xml-chave`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chaveAcesso })
                });

                const result = await response.json();
                hideNotification();

                if (!response.ok || result.error) {
                    showNotification(`Erro: ${result.error || 'Falha desconhecida ao importar XML.'}`, "error");
                } else {
                    showNotification(result.message, "success");
                    chaveInput.value = '';
                    hidePasteModal();
                    switchTab("NOTA FISCAL");
                }
            } catch (error) {
                hideNotification();
                console.error("Erro ao importar XML por chave:", error);
                showNotification("Erro de rede ao tentar importar XML pela chave.", "error");
            }
        }

        async function handleCellEdit(element, sheetRange, sheetName) {
            const newValue = element.textContent.trim();
            const originalValue = element.dataset.originalValue;

            if (newValue === originalValue) {
                return;
            }

            element.classList.add('saving-status'); 

            try {
                const response = await fetch(`${BACKEND_URL}/update-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_name: sheetName, range: sheetRange, value: newValue })
                });

                const result = await response.json();

                element.classList.remove('saving-status');

                if (!response.ok || result.error) {
                    showNotification(`Erro ao salvar ${sheetRange}: ${result.error || 'Erro de servidor.'}`, 'error');
                    element.textContent = originalValue;
                } else {
                    element.dataset.originalValue = newValue;
                    showNotification(`Célula ${sheetRange} atualizada com sucesso para '${newValue}'.`, 'success', 2000);
                }

            } catch (error) {
                element.classList.remove('saving-status');
                console.error("Erro na comunicação para atualizar célula:", error);
                showNotification(`Erro de Rede ao tentar atualizar ${sheetRange}.`, 'error');
                element.textContent = originalValue;
            }
        }

        
        const sheetsConfig = [
            { name: "NOTA FISCAL", range: 'A2:Z' },
            { name: "CONTAGEM LOJA", range: 'A2:Z' },
        ];

        function confirmClearAllSheets() {
            const confirmationMessage = "ATENÇÃO: Você tem certeza que deseja APAGAR TODOS os dados de entrada? Os dados serão atualizados automaticamente após a limpeza.";
            
            if (confirm(confirmationMessage)) {
                clearMultipleSheets();
            }
        }

        async function clearMultipleSheets() {
            showNotification(`Iniciando limpeza em lote das ${sheetsConfig.length} abas de entrada...`, 'loading', 30000);

            let successCount = 0;
            let errorCount = 0;

            for (const config of sheetsConfig) {
                const result = await clearSheetData(config.name, config.range, false); 
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                    showNotification(`Erro ao limpar a aba '${config.name}'.`, 'error', 4000);
                }
            }

            hideNotification();

            if (errorCount === 0) {
                showNotification(`Limpeza global concluída! ${successCount} abas de entrada limpas com sucesso. As fórmulas da Conferência foram preservadas.`, 'success', 5000);
            } else {
                 showNotification(`Limpeza global concluída com ${errorCount} erro(s). Verifique o console.`, 'warning', 8000);
            }

            switchTab('NOTA FISCAL'); 
        }

        async function clearSheetData(sheetName, range, showNotificationOnSuccess = true) {
            if (showNotificationOnSuccess) {
                showNotification(`Limpando dados da aba '${sheetName}' (Range: ${range})...`, 'loading');
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/clear-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_name: sheetName, range: range })
                });

                const result = await response.json();
                
                if (showNotificationOnSuccess) {
                    hideNotification();
                }

                if (!response.ok || result.error) {
                    if (showNotificationOnSuccess) {
                        showNotification(`Erro ao limpar '${sheetName}': ${result.error || 'Erro de servidor.'}`, 'error');
                    }
                    return { success: false, error: result.error || 'Erro de servidor.' };
                } else {
                    if (showNotificationOnSuccess) {
                        showNotification(result.message, 'success');
                    }
                    return { success: true, message: result.message };
                }

            } catch (error) {
                if (showNotificationOnSuccess) {
                    hideNotification();
                    showNotification(`Erro de Rede/CORS ao limpar dados.`, 'error');
                }
                console.error(`Erro de rede ao tentar limpar ${sheetName}:`, error);
                return { success: false, error: 'Erro de rede/comunicação.' };
            }
        }


        // --- Funções de Modal e Notificação (Tailwind) ---

        function showPasteModal() {
            document.getElementById('paste-modal').classList.remove('hidden');
            const chaveInput = document.getElementById("chave-acesso-input");
            if (chaveInput) {
                chaveInput.focus();
            }
        }

        function hidePasteModal() {
            document.getElementById('paste-modal').classList.add('hidden');
        }

        function showNotification(message, type = 'success', duration = 5000) {
            const container = document.getElementById('notifications-container');
            
            let bgColor = 'bg-green-500';
            let icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;

            if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else if (type === 'loading' || type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${type === 'loading' ? 'animate-spin' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707" /></svg>`;
            }

            const notification = document.createElement('div');
            notification.className = `p-4 text-white ${bgColor} rounded-lg shadow-xl flex items-center space-x-3 transition-opacity duration-300 opacity-0`;
            notification.innerHTML = `
                <div>${icon}</div>
                <p class="font-medium">${message}</p>
            `;

            if (type === 'loading') {
                notification.id = 'loading-notification';
            }

            container.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('opacity-0'), 10); 

            if (type !== 'loading') {
                setTimeout(() => {
                    notification.classList.add('opacity-0');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, duration);
            }
        }

        function hideNotification() {
            const loadingNotification = document.getElementById('loading-notification');
            if (loadingNotification) {
                loadingNotification.remove();
            }
        }


        function handleFileUploadChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const xmlContent = e.target.result;
                importXMLData(xmlContent);
                event.target.value = null; 
            };
            reader.onerror = function() {
                showNotification("Erro ao ler o arquivo XML.", 'error');
            };
            reader.readAsText(file);
        }

        // --- Inicialização ---

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.handleCellEdit !== 'function') {
                window.handleCellEdit = async function(element, sheetRange, sheetName) {
                }
            }
            
            const chaveInput = document.getElementById("chave-acesso-input");
            if (chaveInput) {
                chaveInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        importarXMLPorChave(); 
                    }
                });
            }

            switchTab('NOTA FISCAL'); 
        });

    </script>
</body>
</html>
