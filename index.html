<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferir Nota Fiscal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .mock-table th, .mock-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; 
            border-right: 1px solid #e5e7eb; 
        }
        
        /* Regra para remover a linha vertical da última coluna */
        .mock-table th:last-child, .mock-table td:last-child {
            border-right: none;
        }

        .mock-table th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #4b5563; /* gray-600 */
        }
        .mock-table tr:hover {
            background-color: #f9fafb; /* gray-50 */
        }

        /* ---------------------------------------------------------------- */
        /* --- Estilos de Edição/Conferência --- */
        /* ---------------------------------------------------------------- */
        
        /* Estilos base para a coluna Diferença (5ª coluna visível) */
        #conferencia-content tr td:nth-child(5) { 
            font-weight: bold;
            text-align: center; 
        }

        /* ---------------------------------------------------------------- */
        /* --- LARGURAS FIXAS GERAIS (DEFAULT TRUNCADO) --- */
        /* --- Esta regra é "desligada" pela classe .expand-mode-cell --- */
        /* ---------------------------------------------------------------- */
        
        /* Coluna 1 (Código de Barras - 210px) da Conferência */
        #conferencia-table th:nth-child(1),
        #conferencia-table td:nth-child(1) {
             width: 210px; 
             min-width: 210px;
             max-width: 210px;
             overflow: hidden; 
             text-overflow: ellipsis;
             white-space: nowrap;
        }
        
        /* Colunas numéricas/estreitas (70px) da Conferência */
        #conferencia-table th:nth-child(3), 
        #conferencia-table td:nth-child(3),
        #conferencia-table th:nth-child(4), 
        #conferencia-table td:nth-child(4),
        #conferencia-table th:nth-child(5), 
        #conferencia-table td:nth-child(5),
        #conferencia-table th:nth-child(6), 
        #conferencia-table td:nth-child(6) {
             width: 70px; 
             min-width: 70px;
             max-width: 70px;
             overflow: hidden; 
             text-overflow: ellipsis;
             white-space: nowrap;
        }
        
        /* Colunas numéricas/estreitas (70px) da Nota Fiscal */
        #notafiscal-table th:nth-child(2),
        #notafiscal-table td:nth-child(2),
        #notafiscal-table th:nth-child(4),
        #notafiscal-table td:nth-child(4) {
             width: 70px; 
             min-width: 70px;
             max-width: 70px;
             overflow: hidden; 
             text-overflow: ellipsis;
             white-space: nowrap;
             text-align: center; 
        }

        /* Coluna Código de Barras (210px) da Nota Fiscal e Contagem Loja */
        #notafiscal-table th:nth-child(3),
        #notafiscal-table td:nth-child(3),
        #contagem-table th:nth-child(1),
        #contagem-table td:nth-child(1) {
            width: 210px; 
            min-width: 210px;
            max-width: 210px;
            overflow: hidden; 
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: left;
        }

        /* Centraliza os valores numéricos da CONFERENCIA */
        #conferencia-table td:nth-child(3), 
        #conferencia-table td:nth-child(4),
        #conferencia-table td:nth-child(5) {
             text-align: center; 
        }

        /* ---------------------------------------------------------------- */
        /* --- ESTILOS DE MODO (TOGGLE POR JS) --- */
        /* ---------------------------------------------------------------- */

        /* Estilo base para MODO EXPANDIDO (Permite que a célula se ajuste ao conteúdo - Padrão) */
        .expand-mode-cell {
            max-width: none !important;
            min-width: 0 !important;
            overflow-x: visible !important;
            white-space: normal !important;
        }

        /* Classe para MODO SCROLL (COLUNAS DE DESCRIÇÃO E TEXTO LONGO - 150px) */
        .scroll-mode-cell {
            max-width: 150px !important; 
            min-width: 150px !important;
            overflow-x: auto !important; 
            white-space: nowrap !important; 
            text-overflow: clip !important;
        }
        
        /* Classe para MODO SCROLL (COLUNAS NUMÉRICAS OU ESTREITAS - 70px) */
        .scroll-mode-cell-numeric {
            width: 70px !important; 
            min-width: 70px !important;
            max-width: 70px !important;
            overflow-x: auto !important; 
            white-space: nowrap !important;
            text-overflow: clip !important;
            text-align: left !important;
        }
        
        /* Classe para Código de Barras (210px) */
        .scroll-mode-cell-code {
            width: 210px !important; 
            min-width: 210px !important;
            max-width: 210px !important;
            overflow-x: auto !important; 
            white-space: nowrap !important;
            text-overflow: clip !important;
            text-align: left !important;
        }


        /* Classes usadas pelo JavaScript para aplicar as cores */
        .bg-fee2e2 { background-color: #fee2e2; } /* Vermelho suave (red-100) */
        .text-b91c1c { color: #b91c1c; } /* Vermelho escuro (red-700) */
        .bg-green-100 { background-color: #d1fae5; } /* Verde suave */
        .text-green-700 { color: #047857; } /* Verde escuro */


        /* Estilo para células editáveis (Contagem Loja / OBS) */
        [contenteditable="true"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #c7d2fe; 
        }
        
        /* ---------------------------------------------------------------- */
        /* --- Estilos de Impressão (A4) --- */
        /* ---------------------------------------------------------------- */
        @media print {
            body {
                margin: 0;
                padding: 0;
                width: 210mm; 
                min-height: 297mm;
            }

            .container, .bg-white, .shadow-lg {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: none !important;
                border: none !important;
            }
            header, nav, #paste-modal, #notifications-container, .print-hidden {
                display: none !important;
            }

            .mock-table {
                width: 100%;
                font-size: 10pt;
            }
            .mock-table th, .mock-table td {
                padding: 4px; 
                border-bottom: 1px solid #ccc;
                border-right: 1px solid #ccc;
            }
            
            /* Força todas as colunas a expandir na impressão */
            .scroll-mode-cell, .scroll-mode-cell-numeric, .expand-mode-cell, .scroll-mode-cell-code {
                max-width: none !important;
                min-width: 0 !important;
                overflow-x: visible !important;
                white-space: normal !important;
            }
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="container mx-auto px-0 py-4 md:p-8">
        <header class="mb-6 print-hidden">
            <h1 class="text-3xl font-extrabold text-gray-900 md:px-0 px-4">
                Conferir Nota Fiscal
            </h1>
        </header>

        <div class="bg-white rounded-xl shadow-lg border border-gray-100 px-0 pt-6 pb-6 md:p-6">

            <nav class="flex border-b border-gray-200 print-hidden">
                <button data-tab="NOTA FISCAL" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 transition-colors duration-150">NOTA FISCAL</button>
                <button data-tab="CONTAGEM LOJA" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">CONTAGEM LOJA</button>
                <button data-tab="CONFERENCIA" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-150">CONFERENCIA</button>
            </nav>

            <div id="content-stack" class="pt-6">
            </div>
            
        </div>
    </div>

    <div id="paste-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 print-hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 p-6">
            <h3 class="text-lg font-bold mb-4">Colar Chave de Acesso (44 dígitos)</h3>
            <textarea id="chave-acesso-input" class="w-full h-24 p-3 border border-gray-300 rounded-lg resize-none text-sm font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder="Cole a Chave de Acesso (44 dígitos) aqui..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="hidePasteModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                <button onclick="importarXMLPorChave()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">Importar XML por Chave</button>
            </div>
        </div>
    </div>

    <div id="notifications-container" class="fixed bottom-4 right-4 space-y-2 z-50 print-hidden">
    </div>

    <script>
        // --- Variáveis de Configuração ---
        const BACKEND_URL = "https://back-end-nfe.onrender.com";
        const USER_ID = "web-user-123";
        
        // --- Gerenciamento de Abas ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentStack = document.getElementById('content-stack');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });

        /**
         * Altera a aba ativa e carrega o conteúdo.
         * @param {string} sheetName O nome da aba (que é também o nome da planilha no Sheets).
         */
        function switchTab(sheetName) {
            // 1. Atualiza o estilo dos botões
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === sheetName) {
                    btn.classList.add('border-indigo-600', 'text-indigo-600');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                } else {
                    btn.classList.remove('border-indigo-600', 'text-indigo-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                }
            });

            // 2. Limpa o conteúdo e define o placeholder de carregamento
            contentStack.innerHTML = `<div class="text-center py-10 text-gray-500">Carregando dados de ${sheetName}...</div>`;
            
            // 3. Renderiza o layout específico da aba (se houver)
            if (sheetName === "NOTA FISCAL") {
                contentStack.innerHTML = renderNotaFiscalLayout();
            } else if (sheetName === "CONTAGEM LOJA") {
                contentStack.innerHTML = renderContagemLojaLayout();
            } else if (sheetName === "CONFERENCIA") {
                contentStack.innerHTML = renderConferenciaLayout();
            }
            
            // 4. Inicia a busca de dados no backend
            loadTabContent(sheetName);
        }

        // ÍCONES
        const documentIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
        const printerIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m-1-5a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2zm-4 4h4v2a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2h4z" /></svg>`;


        /**
         * Retorna o HTML completo da aba NOTA FISCAL (botões + placeholder da tabela).
         */
        function renderNotaFiscalLayout() {
            return `
                <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                    <label for="xml-file-upload" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 cursor-pointer text-sm font-medium border border-gray-300">
                        <span class="text-orange-600">${documentIcon}</span>
                        <span>Importar Nota Fiscal (XML)</span>
                    </label>
                    <input type="file" id="xml-file-upload" accept=".xml" class="hidden" onchange="handleFileUploadChange(event)">
                    
                    <button id="show-paste-modal" onclick="showPasteModal()" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150 text-sm font-medium border border-gray-300">
                        <span class="text-yellow-600">${documentIcon}</span>
                        <span>Importar por Chave de Acesso</span>
                    </button>
                    
                    <button onclick="toggleScrollMode('NOTA FISCAL')" id="scroll-button-notafiscal" class="flex items-center space-x-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:bg-indigo-200 transition duration-150 text-sm font-medium border border-indigo-300">
                        <span>Modo Scroll</span>
                    </button>

                    <button onclick="confirmClearAllSheets()" class="flex items-center space-x-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg shadow-sm hover:bg-red-100 transition duration-150 text-sm font-medium border border-red-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-2 0v6a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
                        <span>Apagar Dados</span>
                    </button>
                </div>
                <div id="dynamic-table-content">
                    <p class="text-center text-gray-400 py-10">Use o botão de importação (XML) para carregar dados nesta aba.</p>
                </div>
            `;
        }

        /**
         * Retorna o HTML completo da aba CONTAGEM LOJA.
         */
        function renderContagemLojaLayout() {
            return `
                <div id="contagem-loja-content">
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4 print-hidden">
                        <p class="font-semibold text-yellow-800 text-lg">Escanear abaixo 11</p>
                    </div>
                    <div id="dynamic-table-content-contagem">
                        <p class="text-center text-gray-400 py-10">Carregando dados...</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Retorna o HTML completo da aba CONFERENCIA (com botão de impressão e modo scroll).
         */
        function renderConferenciaLayout() {
            return `
                <div id="conferencia-content">
                    <div class="flex flex-wrap gap-3 pb-4 mb-4 border-b border-gray-200 print-hidden">
                        <button onclick="printConferencia()" class="flex items-center space-x-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg shadow-sm hover:bg-blue-200 transition duration-150 text-sm font-medium border border-blue-300">
                            <span class="text-blue-600">${printerIcon}</span>
                            <span>Imprimir Conferência</span>
                        </button>
                        <button onclick="toggleScrollMode('CONFERENCIA')" id="scroll-button-conferencia" class="flex items-center space-x-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:bg-indigo-200 transition duration-150 text-sm font-medium border border-indigo-300">
                            <span>Modo Scroll</span>
                        </button>
                    </div>
                    <div id="dynamic-table-content-conferencia">
                        <p class="text-center text-gray-400 py-10">Carregando dados...</p>
                    </div>
                </div>
            `;
        }

        /**
         * Abre a caixa de diálogo de impressão do navegador com estilos A4.
         */
        function printConferencia() {
            window.print();
        }

        /**
         * Renderiza a tabela da Contagem Loja com 3000 linhas pré-renderizadas.
         */
        function renderContagemTableFixedRows(data, headers) {
            const fixedRows = 3000;
            // Assume que a primeira linha de `data` é o cabeçalho se for retornado do Sheets
            const existingData = (data.length > 0 && headers.length > 0 && String(data[0][0]) === headers[0]) 
                                 ? data.slice(1) 
                                 : data; 

            let html = `
                <div class="rounded-lg border border-gray-200 overflow-x-auto shadow-sm">
                    <table class="mock-table w-full text-sm" id="contagem-table">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr><th class="expand-mode-cell">Código de Barras</th></tr>
                        </thead>
                        <tbody>`;

            for (let rowIndex = 0; rowIndex < fixedRows; rowIndex++) {
                // A contagem no Sheets começa em 2 (A2)
                const sheetRowIndex = rowIndex + 2; 
                const sheetRange = `A${sheetRowIndex}`;
                
                // Pega o valor existente da célula (se houver)
                const cellValue = (existingData[rowIndex] && existingData[rowIndex][0] !== undefined) 
                                ? existingData[rowIndex][0] 
                                : '';
                
                // Define os atributos para a célula editável
                const editAttributes = `contenteditable="true"
                                        onblur="handleCellEdit(this, '${sheetRange}', 'CONTAGEM LOJA')"
                                        onkeydown="handleContagemKeyPress(event, '${sheetRange}', 'CONTAGEM LOJA')"
                                        data-original-value="${cellValue}"
                                        data-sheet-range="${sheetRange}"`;
                
                // Aplica a classe de expandido por padrão
                const cellClasses = 'cursor-text hover:bg-indigo-50/50 focus:bg-indigo-100 border border-transparent focus:border-indigo-400 transition expand-mode-cell';

                html += `<tr data-row-index="${sheetRowIndex}">
                            <td ${editAttributes} class="${cellClasses}">${cellValue}</td>
                         </tr>`;
            }

            html += `</tbody></table></div>`;
            return html;
        }


        /**
         * Renderiza os dados do Sheets em uma tabela HTML (usado para NF e Conferência).
         */
        function renderTable(sheetName, data, headers) {
            
            if (!data || data.length === 0) {
                return `<p class="text-center text-gray-500 py-10">Nenhum dado encontrado no Google Sheets para esta aba.</p>`;
            }

            const isConferencia = sheetName === "CONFERENCIA";
            const isStatusEditable = isConferencia;
            
            // Adiciona ID à tabela para ser alvo do toggleScrollMode
            let tableID = '';
            if (sheetName === 'CONFERENCIA') {
                tableID = 'conferencia-table';
            } else if (sheetName === 'NOTA FISCAL') {
                tableID = 'notafiscal-table';
            }

            let html = `
                <div class="rounded-lg border border-gray-200 overflow-x-auto shadow-sm">
                    <table class="mock-table w-full text-sm" id="${tableID}">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>`;
            
            headers.forEach(h => {
                html += `<th class="w-auto whitespace-nowrap">${h}</th>`;
            });
            html += `</tr></thead><tbody>`;

            let dataRows = data;
            
            if (data.length > 0 && headers.length > 0 && String(data[0][0]) === headers[0]) {
                dataRows = data.slice(1);
            }

            dataRows.forEach((row, rowIndex) => {
                const isRowEmpty = row.length === 0 || row.every(cell => !cell || String(cell).trim() === '');
                if (isRowEmpty) return; 

                const sheetRowIndex = (data[0][0] === headers[0] ? rowIndex + 2 : rowIndex + 1);
                
                html += `<tr data-row-index="${sheetRowIndex}">`;
                
                for (let i = 0; i < headers.length; i++) {
                    const cellValue = row[i] !== undefined ? row[i] : '';
                    
                    const sheetCol = String.fromCharCode(65 + i);
                    const sheetRange = `${sheetCol}${sheetRowIndex}`;

                    let editAttributes = '';
                    let cellClasses = '';

                    // Apenas a coluna OBS (i=5) é editável na Conferência
                    const isCellEditable = (isStatusEditable && i === 5);

                    if (isCellEditable) {
                        editAttributes = `contenteditable="true"
                                         onblur="handleCellEdit(this, '${sheetRange}', '${sheetName}')"
                                         data-original-value="${cellValue}"
                                         data-sheet-range="${sheetRange}"`;
                        
                        cellClasses = 'cursor-text hover:bg-indigo-50/50 focus:bg-indigo-100 border border-transparent focus:border-indigo-400 transition';
                    }
                    
                    // Lógica para aplicar a classe inicial de EXPANSÃO (Expand Mode)
                    let columnsToExpand = [];
                    if (isConferencia) {
                         columnsToExpand = [1, 2, 3, 4, 5, 6]; 
                    } else if (sheetName === "NOTA FISCAL") {
                         columnsToExpand = [1, 2, 3, 4]; 
                    }
                    
                    if (columnsToExpand.includes(i + 1)) { 
                         cellClasses += ' expand-mode-cell'; 
                    }

                    html += `<td ${editAttributes} class="${cellClasses}">${cellValue}</td>`;
                }
                html += `</tr>`;
            });
            
            html += `</tbody></table></div>`;
            return html;
        }


        /**
         * Gerencia a busca de dados e a renderização do conteúdo da aba.
         */
        async function loadTabContent(sheetName) {
            const data = await fetchSheetData(sheetName);

            let targetElementId = 'dynamic-table-content';
            let headers = [];

            if (sheetName === "NOTA FISCAL") {
                headers = ["Descrição", "Quantidade", "Código de Barras", "Item"];
                targetElementId = 'dynamic-table-content';
                const targetElement = document.getElementById(targetElementId);
                if (targetElement) {
                    targetElement.innerHTML = renderTable(sheetName, data, headers);
                }

            } else if (sheetName === "CONTAGEM LOJA") {
                headers = ["Código de Barras"]; 
                targetElementId = 'dynamic-table-content-contagem';
                
                // Renderiza a tabela de 3000 linhas fixas
                const targetElement = document.getElementById(targetElementId);
                if (targetElement) {
                    targetElement.innerHTML = renderContagemTableFixedRows(data, headers);
                    
                    // NOVO: Chama a função que encontra a primeira célula vazia, foca nela e rola a tela
                    // Usamos setTimeout e requestAnimationFrame para garantir que a lógica de foco
                    // e cursor seja executada após a renderização e o foco padrão do navegador.
                    setTimeout(() => {
                        requestAnimationFrame(focusNextEmptyContagemCell);
                    }, 100); // Aumento do delay para maior estabilidade no foco
                }

            } else if (sheetName === "CONFERENCIA") {
                headers = ["Código de Barras", "Descrição do Produto", "Quantidade NF", "Contagem Loja", "Diferença", "OBS"]; 
                targetElementId = 'dynamic-table-content-conferencia';
                
                const targetElement = document.getElementById(targetElementId);
                if (targetElement) {
                    targetElement.innerHTML = renderTable(sheetName, data, headers);
                    
                    // Aplica estilos condicionais após a renderização
                    setTimeout(() => {
                        applyConferenciaStyles(headers.length);
                    }, 0);
                }
            }
        }
        
        /**
         * Encontra a primeira célula vazia (após a última preenchida) na Contagem Loja, 
         * foca nela e rola a tela.
         * Esta função só busca células contenteditable, que começam em A2.
         */
        function focusNextEmptyContagemCell() {
            // Seleciona todas as células editáveis (TD), ignorando o cabeçalho (TH - A1)
            const cells = document.querySelectorAll('#contagem-table td[contenteditable="true"]');
            
            // Inicia como nulo.
            let cellToFocus = null; 
            
            // 1. Itera sobre todas as células para encontrar a primeira que está vazia
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                // Verifica o conteúdo renderizado (que veio do backend)
                const value = cell.textContent.trim();
                
                if (value === '') {
                    // Encontrou a primeira célula vazia (ou A2 se a lista estiver vazia).
                    cellToFocus = cell;
                    break; 
                }
            }
            
            // 2. Determina a célula final de foco (se houver)
            if (!cellToFocus) {
                // Se nenhuma célula vazia foi encontrada (lista cheia ou grande), 
                // foca na última célula preenchida.
                if (cells.length > 0) {
                    cellToFocus = cells[cells.length - 1];
                    showNotification("Aviso: A lista de contagem pode estar cheia (3000 linhas). Foco na última célula preenchida.", 'warning', 5000);
                }
            }
            
            // 3. Foca na célula (se encontrada), ajusta o cursor e rola a tela
            if (cellToFocus) {
                // Rola o contêiner para que a célula fique visível
                cellToFocus.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                cellToFocus.focus();
                
                // moveCursorToEnd é crucial para que o navegador não selecione o texto,
                // o que causaria a sobrescrita pelo próximo caractere digitado/scaneado.
                moveCursorToEnd(cellToFocus); 
            }
        }


        /**
         * Utilitário para mover o cursor de edição para o final do texto em uma célula contenteditable.
         */
        function moveCursorToEnd(element) {
            const range = document.createRange();
            const selection = window.getSelection();
            
            // Garante que o cursor está no final do nó de texto, evitando a seleção total.
            // Se o elemento estiver vazio (caso padrão), childNodes.length será 0 e o cursor 
            // será posicionado em 0, o que é o início.
            if (element.childNodes.length > 0) {
                 const node = element.childNodes[0];
                 // Verifica se é um nó de texto (para evitar erros em outros tipos de nós)
                 if (node.nodeType === 3) {
                     range.setStart(node, node.length);
                 } else {
                     range.setStart(element, 0);
                 }
            } else {
                 range.setStart(element, 0);
            }

            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        /**
         * Alterna entre o Modo Scroll e o Modo Expandido para a tabela especificada.
         */
        function toggleScrollMode(sheetName) {
            const tableID = sheetName === 'CONFERENCIA' ? 'conferencia-table' : 'notafiscal-table';
            const buttonID = sheetName === 'CONFERENCIA' ? 'scroll-button-conferencia' : 'scroll-button-notafiscal';

            const table = document.getElementById(tableID);
            const button = document.getElementById(buttonID);

            if (!table || !button) return;
            
            const isScrollModeActive = button.textContent === 'Modo Expandido';
            
            let columnsToTarget = [];
            const scrollClassDesc = 'scroll-mode-cell';
            const scrollClassNumeric = 'scroll-mode-cell-numeric';
            const scrollClassCode = 'scroll-mode-cell-code'; 

            if (sheetName === 'CONFERENCIA') {
                columnsToTarget = [1, 2, 3, 4, 5, 6];
            } else if (sheetName === 'NOTA FISCAL') {
                columnsToTarget = [1, 2, 3, 4];
            }

            columnsToTarget.forEach(colIndex => {
                const cells = table.querySelectorAll(`th:nth-child(${colIndex}), td:nth-child(${colIndex})`);
                
                cells.forEach(cell => {
                    
                    if (isScrollModeActive) {
                        // Mudar para MODO EXPANDIDO (Remove todas as classes de scroll)
                        cell.classList.remove(scrollClassDesc, scrollClassNumeric, scrollClassCode);
                        cell.classList.add('expand-mode-cell'); 
                    } else {
                        // Mudar para MODO SCROLL
                        cell.classList.remove('expand-mode-cell');

                        if (sheetName === 'CONFERENCIA') {
                            if (colIndex === 1) {
                                cell.classList.add(scrollClassCode); 
                            } 
                            else if (colIndex === 2) {
                                cell.classList.add(scrollClassDesc);
                            }
                            else if (colIndex >= 3 && colIndex <= 6) {
                                cell.classList.add(scrollClassNumeric);
                            }
                            
                        } else if (sheetName === 'NOTA FISCAL') {
                            if (colIndex === 2 || colIndex === 4) {
                                cell.classList.add(scrollClassNumeric);
                            } else if (colIndex === 3) {
                                cell.classList.add(scrollClassCode); 
                            } else { 
                                cell.classList.add(scrollClassDesc);
                            }
                        }
                    }
                });
            });

            // Atualiza o texto do botão
            if (isScrollModeActive) {
                button.textContent = 'Modo Scroll';
                button.classList.remove('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200', 'border-gray-300');
                button.classList.add('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200', 'border-indigo-300');
            } else {
                button.textContent = 'Modo Expandido';
                button.classList.remove('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200', 'border-indigo-300');
                button.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200', 'border-gray-300');
            }
        }

        
        /**
         * Aplica formatação condicional à coluna Diferença (E) na aba CONFERENCIA.
         */
        function applyConferenciaStyles(numCols) {
            const rows = document.querySelectorAll('#conferencia-content .mock-table tbody tr');

            rows.forEach(row => {
                const diffCell = row.querySelector('td:nth-child(5)');
                if (!diffCell) return;

                let value = parseFloat(diffCell.textContent.replace(',', '.').trim());
                
                diffCell.classList.remove('bg-fee2e2', 'text-b91c1c', 'bg-green-100', 'text-green-700');

                if (isNaN(value) || value === 0) {
                } else if (value < 0) {
                    diffCell.classList.add('bg-fee2e2', 'text-b91c1c');
                } else if (value > 0) {
                    diffCell.classList.add('bg-green-100', 'text-green-700');
                }
            });
        }


        // --- Funções de API e Utilitários ---

        function handleContagemKeyPress(event, sheetRange, sheetName) {
            if (event.keyCode === 13) {
                event.preventDefault();
                
                const element = event.target;
                // 1. Salva a célula atual
                handleCellEdit(element, sheetRange, sheetName);

                // 2. Calcula a próxima linha 
                const currentRow = parseInt(sheetRange.slice(1));
                const nextRow = currentRow + 1;
                const nextRange = `A${nextRow}`;

                // 3. Tenta encontrar a próxima célula pré-renderizada (A3, A4, etc.)
                const nextCell = document.querySelector(`td[data-sheet-range="${nextRange}"]`);
                
                if (nextCell) {
                    // Limpa o conteúdo e foca na próxima
                    nextCell.textContent = '';
                    nextCell.dataset.originalValue = '';
                    nextCell.focus();
                } else {
                    // Se não encontrar (passou da linha 3001), não faz nada.
                    showNotification("Fim da lista pré-renderizada. Pressione F5 para recarregar a página e continuar a contagem.", 'warning', 5000);
                }
            }
        }

        async function fetchSheetData(sheetName) {
            showNotification(`Buscando dados da aba '${sheetName}'...`, 'loading');
            
            try {
                const response = await fetch(`${BACKEND_URL}/fetch-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_name: sheetName })
                });

                const result = await response.json();
                hideNotification();

                if (!response.ok || result.error) {
                    showNotification(`Erro ao carregar '${sheetName}': ${result.error || 'Erro de servidor.'}`, 'error');
                    return [];
                }
                
                return result.data || [];

            } catch (error) {
                hideNotification();
                console.error("Erro na comunicação para buscar dados:", error);
                showNotification(`Erro de Rede/CORS ao buscar dados para ${sheetName}.`, 'error');
                return [];
            }
        }
        
        async function importXMLData(xmlContent) {
            if (!xmlContent || xmlContent.trim().length < 100) {
                showNotification("Conteúdo XML vazio ou inválido para importação.", 'warning');
                return;
            }

            showNotification("Enviando XML para o backend Go...", 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/import-xml-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ xml_content: xmlContent, user_id: USER_ID })
                });

                const result = await response.json();
                hideNotification();

                if (!response.ok || result.error) {
                    showNotification(`Falha na Importação: ${result.error || 'Erro desconhecido do servidor.'}`, 'error');
                } else {
                    showNotification(result.message, 'success');
                    switchTab("NOTA FISCAL");
                }

            } catch (error) {
                hideNotification();
                console.error("Erro de Rede:", error);
                showNotification("Erro de Rede ao tentar conectar com o servidor Go. Verifique se ele está rodando em https://back-end-nfe.onrender.com", 'error');
            }
        }

        async function importarXMLPorChave() {
            const chaveInput = document.getElementById("chave-acesso-input");
            if (!chaveInput) {
                showNotification("Campo de chave não encontrado.", "error");
                return;
            }
            const chaveAcesso = chaveInput.value.trim();

            if (!chaveAcesso || chaveAcesso.length !== 44) {
                showNotification("Chave de acesso inválida. Deve conter 44 dígitos.", "warning");
                return;
            }

            showNotification("Importando XML pela chave de acesso...", "loading");

            try {
                const response = await fetch(`${BACKEND_URL}/importar-xml-chave`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chaveAcesso })
                });

                const result = await response.json();
                hideNotification();

                if (!response.ok || result.error) {
                    showNotification(`Erro: ${result.error || 'Falha desconhecida ao importar XML.'}`, "error");
                } else {
                    showNotification(result.message, "success");
                    chaveInput.value = '';
                    hidePasteModal();
                    switchTab("NOTA FISCAL");
                }
            } catch (error) {
                hideNotification();
                console.error("Erro ao importar XML por chave:", error);
                showNotification("Erro de rede ao tentar importar XML pela chave.", "error");
            }
        }
        
        /**
         * Função CRUCIAL: Envia o novo valor da célula editável para o Google Sheets.
         */
        async function handleCellEdit(element, sheetRange, sheetName) {
            const newValue = element.textContent.trim();
            const originalValue = element.dataset.originalValue; 

            if (newValue === originalValue) {
                return;
            }

            element.classList.add('saving-status'); 

            try {
                const response = await fetch(`${BACKEND_URL}/update-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_name: sheetName, range: sheetRange, value: newValue })
                });

                const result = await response.json();

                element.classList.remove('saving-status');

                if (!response.ok || result.error) {
                    showNotification(`Erro ao salvar ${sheetRange}: ${result.error || 'Erro de servidor.'}`, 'error');
                    // Reverte o valor da célula em caso de falha de salvamento
                    element.textContent = originalValue; 
                } else {
                    // Atualiza o valor original para o novo valor salvo
                    element.dataset.originalValue = newValue;
                    showNotification(`Célula ${sheetRange} atualizada com sucesso para '${newValue}'.`, 'success', 2000);
                }

            } catch (error) {
                element.classList.remove('saving-status');
                console.error("Erro na comunicação para atualizar célula:", error);
                showNotification(`Erro de Rede ao tentar atualizar ${sheetRange}.`, 'error');
                // Reverte o valor da célula em caso de falha de rede
                element.textContent = originalValue;
            }
        }

        
        const sheetsConfig = [
            { name: "NOTA FISCAL", range: 'A2:Z' },
            { name: "CONTAGEM LOJA", range: 'A2:Z' },
            // Coluna OBS (F) na Conferência
            { name: "CONFERENCIA", range: 'F2:F' } 
        ];

        function confirmClearAllSheets() {
            const confirmationMessage = "ATENÇÃO: Você tem certeza que deseja APAGAR TODOS os dados de entrada (Nota Fiscal e Contagem Loja) E a coluna OBS da Conferência?";
            
            if (confirm(confirmationMessage)) {
                clearMultipleSheets();
            }
        }

        async function clearMultipleSheets() {
            showNotification(`Iniciando limpeza em lote das ${sheetsConfig.length} abas de entrada...`, 'loading', 30000);

            let successCount = 0;
            let errorCount = 0;

            for (const config of sheetsConfig) {
                const result = await clearSheetData(config.name, config.range, false); 
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                    showNotification(`Erro ao limpar a aba '${config.name}' (Range: ${config.range}).`, 'error', 4000);
                }
            }

            hideNotification();

            if (errorCount === 0) {
                showNotification(`Limpeza global concluída! ${successCount} ações de limpeza realizadas com sucesso.`, 'success', 5000);
            } else {
                 showNotification(`Limpeza global concluída com ${errorCount} erro(s). Verifique o console.`, 'warning', 8000);
            }

            switchTab('NOTA FISCAL'); 
        }

        async function clearSheetData(sheetName, range, showNotificationOnSuccess = true) {
            if (showNotificationOnSuccess) {
                showNotification(`Limpando dados da aba '${sheetName}' (Range: ${range})...`, 'loading');
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/clear-sheet-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_name: sheetName, range: range })
                });

                const result = await response.json();
                
                if (showNotificationOnSuccess) {
                    hideNotification();
                }

                if (!response.ok || result.error) {
                    if (showNotificationOnSuccess) {
                        showNotification(`Erro ao limpar '${sheetName}': ${result.error || 'Erro de servidor.'}`, 'error');
                    }
                    return { success: false, error: result.error || 'Erro de servidor.' };
                } else {
                    if (showNotificationOnSuccess) {
                        showNotification(result.message, 'success');
                    }
                    return { success: true, message: result.message };
                }

            } catch (error) {
                if (showNotificationOnSuccess) {
                    hideNotification();
                    showNotification(`Erro de Rede/CORS ao limpar dados.`, 'error');
                }
                console.error(`Erro de rede ao tentar limpar ${sheetName}:`, error);
                return { success: false, error: 'Erro de rede/comunicação.' };
            }
        }


        // --- Funções de Modal e Notificação (Tailwind) ---

        function showPasteModal() {
            document.getElementById('paste-modal').classList.remove('hidden');
            const chaveInput = document.getElementById("chave-acesso-input");
            if (chaveInput) {
                chaveInput.focus();
            }
        }

        function hidePasteModal() {
            document.getElementById('paste-modal').classList.add('hidden');
        }

        function showNotification(message, type = 'success', duration = 5000) {
            const container = document.getElementById('notifications-container');
            
            let bgColor = 'bg-green-500';
            let icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;

            if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else if (type === 'loading' || type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${type === 'loading' ? 'animate-spin' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707" /></svg>`;
            }

            const notification = document.createElement('div');
            notification.className = `p-4 text-white ${bgColor} rounded-lg shadow-xl flex items-center space-x-3 transition-opacity duration-300 opacity-0`;
            notification.innerHTML = `
                <div>${icon}</div>
                <p class="font-medium">${message}</p>
            `;

            if (type === 'loading') {
                notification.id = 'loading-notification';
            }

            container.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('opacity-0'), 10); 

            if (type !== 'loading') {
                setTimeout(() => {
                    notification.classList.add('opacity-0');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, duration);
            }
        }

        function hideNotification() {
            const loadingNotification = document.getElementById('loading-notification');
            if (loadingNotification) {
                loadingNotification.remove();
            }
        }


        function handleFileUploadChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const xmlContent = e.target.result;
                importXMLData(xmlContent);
                event.target.value = null; 
            };
            reader.onerror = function() {
                showNotification("Erro ao ler o arquivo XML.", 'error');
            };
            reader.readAsText(file);
        }

        // --- Inicialização ---

        document.addEventListener('DOMContentLoaded', () => {
            // Garante que o listener para ENTER no campo da chave de acesso do modal funcione
            const chaveInput = document.getElementById("chave-acesso-input");
            if (chaveInput) {
                chaveInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        importarXMLPorChave(); 
                    }
                });
            }

            switchTab('NOTA FISCAL'); 
        });

    </script>
</body>
</html>
